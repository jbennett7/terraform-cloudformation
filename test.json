{"AWSTemplateFormatVersion":"2010-09-09","Description":"Template for AWS data ingest into Splunk using AWS Kinesis Firehose and AWS Lambda.","Mappings":{"BucketMap":{"us-east-1":{"BucketName":"trumpet-splunk-prod-us-east-1"},"us-east-2":{"BucketName":"trumpet-splunk-prod-us-east-2"},"us-west-1":{"BucketName":"trumpet-splunk-prod-us-west-1"},"us-west-2":{"BucketName":"trumpet-splunk-prod-us-west-2"},"ca-central-1":{"BucketName":"trumpet-splunk-prod-ca-central-1"},"eu-central-1":{"BucketName":"trumpet-splunk-prod-eu-central-1"},"eu-west-1":{"BucketName":"trumpet-splunk-prod-eu-west-1"},"eu-west-2":{"BucketName":"trumpet-splunk-prod-eu-west-2"},"eu-west-3":{"BucketName":"trumpet-splunk-prod-eu-west-3"},"ap-northeast-1":{"BucketName":"trumpet-splunk-prod-ap-northeast-1"},"ap-northeast-2":{"BucketName":"trumpet-splunk-prod-ap-northeast-2"},"ap-southeast-1":{"BucketName":"trumpet-splunk-prod-ap-southeast-1"},"ap-southeast-2":{"BucketName":"trumpet-splunk-prod-ap-southeast-2"},"ap-south-1":{"BucketName":"trumpet-splunk-prod-ap-south-1"},"sa-east-1":{"BucketName":"trumpet-splunk-prod-sa-east-1"}}},"Resources":{"VPCtoKinesisFirehoseRole":{"Type":"AWS::IAM::Role","Properties":{"Policies":[{"PolicyName":"VPCtoKinesisFirehosePolicy","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["firehose:*"],"Resource":["arn:aws:firehose:*:*:*"]},{"Effect":"Allow","Action":["iam:PassRole"],"Resource":["arn:aws:iam::*:role/VPCtoKinesisFirehoseRole"]}]}}],"AssumeRolePolicyDocument":{"Version":"2012-10-17","Statement":{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":{"Fn::Join":["",["logs.",{"Ref":"AWS::Region"},".amazonaws.com"]]}}}}}},"VPCFirehoseDeliveryStream":{"Type":"AWS::KinesisFirehose::DeliveryStream","Properties":{"SplunkDestinationConfiguration":{"S3Configuration":{"CompressionFormat":"UNCOMPRESSED","BucketARN":{"Fn::GetAtt":["VPCBackupS3Bucket","Arn"]},"RoleARN":{"Fn::GetAtt":["VPCBackupS3Role","Arn"]},"BufferingHints":{"IntervalInSeconds":300,"SizeInMBs":1}},"HECEndpointType":"Event","HECToken":"598a156d-7e36-4bb5-a8f5-9cb095b490c0","HECAcknowledgmentTimeoutInSeconds":180,"RetryOptions":{"DurationInSeconds":300},"HECEndpoint":"https://splunk.jbennettconsulting.com","S3BackupMode":"FailedEventsOnly","ProcessingConfiguration":{"Enabled":true,"Processors":[{"Parameters":[{"ParameterName":"LambdaArn","ParameterValue":{"Fn::GetAtt":["VPCFirehoseProcessor","Arn"]}},{"ParameterName":"RoleArn","ParameterValue":{"Fn::GetAtt":["VPCBackupS3Role","Arn"]}}],"Type":"Lambda"}]}},"DeliveryStreamType":"DirectPut"}},"VPCFirehoseDeliveryRole":{"Type":"AWS::IAM::Role","Properties":{"AssumeRolePolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":"sts:AssumeRole","Sid":"","Effect":"Allow","Principal":{"Service":"events.amazonaws.com"}}]}}},"VPCFirehoseDeliveryPolicy":{"Type":"AWS::IAM::Policy","Properties":{"PolicyName":"firehose_delivery_policy","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":["firehose:PutRecord","firehose:PutRecordBatch"],"Resource":[{"Fn::GetAtt":["VPCFirehoseDeliveryStream","Arn"]}],"Effect":"Allow"}]},"Roles":[{"Ref":"VPCFirehoseDeliveryRole"}]}},"VPCBackupS3Bucket":{"Type":"AWS::S3::Bucket","Properties":{"VersioningConfiguration":{"Status":"Enabled"}}},"VPCBackupS3Role":{"Type":"AWS::IAM::Role","Properties":{"Path":"/","Policies":[{"PolicyName":"VPCBackupS3Role","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":["s3:AbortMultipartUpload","s3:GetBucketLocation","s3:GetObject","s3:ListBucket","s3:ListBucketMultipartUploads","s3:PutObject"],"Resource":"*","Effect":"Allow"},{"Effect":"Allow","Action":["lambda:InvokeFunction","lambda:GetFunctionConfiguration"],"Resource":"*"},{"Action":["logs:CreateLogGroup","logs:CreateLogStream","logs:PutLogEvents"],"Resource":"*","Effect":"Allow"}]}}],"AssumeRolePolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":"sts:AssumeRole","Sid":"","Effect":"Allow","Principal":{"Service":"firehose.amazonaws.com"}}]}}},"VPCFirehoseProcessorRole":{"Type":"AWS::IAM::Role","Properties":{"Path":"/","ManagedPolicyArns":["arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"],"Policies":[{"PolicyName":"VPCFirehoseProcessorPolicy","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":"logs:CreateLogGroup","Resource":"arn:aws:logs:*:*:*"},{"Effect":"Allow","Action":["logs:CreateLogStream","logs:PutLogEvents"],"Resource":["arn:aws:logs:*:*:*:*:*"]}]}}],"AssumeRolePolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":["sts:AssumeRole"],"Effect":"Allow","Principal":{"Service":["lambda.amazonaws.com"]}}]}}},"VPCFirehoseProcessor":{"Type":"AWS::Lambda::Function","Properties":{"Code":{"S3Bucket":{"Fn::FindInMap":["BucketMap",{"Ref":"AWS::Region"},"BucketName"]},"S3Key":"splunk_vpc_firehose_processor_v0.2.zip"},"Description":"Stream events from VPC Flow Logs to Splunk using HTTP event collector","MemorySize":512,"Handler":"lambda_function.handler","Role":{"Fn::GetAtt":["VPCFirehoseProcessorRole","Arn"]},"Timeout":300,"Runtime":"python2.7"}},"VPCFlowLogSubscriptionFilterawsvpccontinoflowlogs":{"Type":"AWS::Logs::SubscriptionFilter","Properties":{"RoleArn":{"Fn::GetAtt":["VPCtoKinesisFirehoseRole","Arn"]},"LogGroupName":"/aws/vpc/contino/flowlogs","FilterPattern":"","DestinationArn":{"Fn::GetAtt":["VPCFirehoseDeliveryStream","Arn"]}}}}}